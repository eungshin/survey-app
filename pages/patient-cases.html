<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>전문가 설문 시스템 - 환자 케이스 준비</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Pretendard:wght@100;200;300;400;500;600;700;800;900&display=swap"
        rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Nanum+Gothic:wght@400;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/main.css">
</head>

<body>
    <div class="app-container large" style="position: relative;">
        <!-- Global Header Icons -->
        <div class="global-header-icons">
            <button class="header-icon-btn" onclick="showMypageModal()">
                <svg width="32" height="32" viewBox="0 0 32 32" fill="none">
                    <circle cx="16" cy="11" r="5" stroke="#666" stroke-width="2" />
                    <path d="M6 26C6 20.4772 10.4772 16 16 16C21.5228 16 26 20.4772 26 26" stroke="#666"
                        stroke-width="2" />
                </svg>
            </button>
            <button class="header-icon-btn" onclick="showExitModal()">
                <svg width="32" height="32" viewBox="0 0 32 32" fill="none">
                    <path d="M8 8L24 24M8 24L24 8" stroke="#666" stroke-width="2" stroke-linecap="round" />
                </svg>
            </button>
        </div>

        <!-- MyPage Confirmation Modal -->
        <div class="modal-overlay" id="mypageModal">
            <div class="modal">
                <p class="modal-description" style="text-align: center; margin-bottom: 24px; font-size: 18px;">
                    설문 조사를 중단하고 마이페이지로 이동하시겠습니까?
                </p>
                <div class="modal-actions" style="display: flex; justify-content: center; gap: 12px;">
                    <button class="btn btn-outline-primary" style="min-width: 100px;" onclick="goToMypage()">예</button>
                    <button class="btn btn-outline-primary" style="min-width: 100px; border-color: #ccc; color: #666;"
                        onclick="closeMypageModal()">아니요</button>
                </div>
            </div>
        </div>

        <!-- Exit Confirmation Modal -->
        <div class="modal-overlay" id="exitModal">
            <div class="modal">
                <p class="modal-description" style="text-align: center; margin-bottom: 24px; font-size: 18px;">
                    설문을 끝내고 메타 세미나 공간으로 이동하시겠습니까?
                </p>
                <div class="modal-actions" style="display: flex; justify-content: center; gap: 12px;">
                    <button class="btn btn-outline-primary" style="min-width: 100px;" onclick="exitPage()">예</button>
                    <button class="btn btn-outline-primary" style="min-width: 100px; border-color: #ccc; color: #666;"
                        onclick="closeExitModal()">아니요</button>
                </div>
            </div>
        </div>

        <!-- ========== Page 4: Patient Case Prep (Questions) ========== -->
        <section class="page-section">
            <div class="content-with-sidebar">
                <!-- Progress Sidebar -->
                <div class="progress-sidebar">
                    <div class="progress-step completed" onclick="location.href='survey-intro.html'"
                        style="cursor: pointer;">
                        <div class="step-icon">
                            <svg width="15" height="9" viewBox="0 0 15 9" fill="none">
                                <path d="M1 4L5 8L14 1" stroke="white" stroke-width="3" />
                            </svg>
                        </div>
                        <span class="step-label">참여 가능 설문</span>
                    </div>

                    <div class="progress-step completed" onclick="location.href='survey-info-consent.html'"
                        style="cursor: pointer;">
                        <div class="step-icon">
                            <svg width="15" height="9" viewBox="0 0 15 9" fill="none">
                                <path d="M1 4L5 8L14 1" stroke="white" stroke-width="3" />
                            </svg>
                        </div>
                        <span class="step-label">개인정보동의</span>
                    </div>

                    <div class="progress-step completed" onclick="location.href='medical-info.html'"
                        style="cursor: pointer;">
                        <div class="step-icon">
                            <svg width="15" height="9" viewBox="0 0 15 9" fill="none">
                                <path d="M1 4L5 8L14 1" stroke="white" stroke-width="3" />
                            </svg>
                        </div>
                        <span class="step-label">의료진 정보 설문</span>
                    </div>

                    <div class="progress-step active" onclick="location.href='patient-cases.html'"
                        style="cursor: pointer;">
                        <div class="step-number">4</div>
                        <span class="step-label">환자별 설문</span>
                    </div>
                </div>

                <!-- Right Content Area -->
                <div style="flex: 1;">
                    <!-- Patient Case Number (Centered, aligned with card) -->
                    <div
                        style="text-align: center; margin-bottom: 12px; color: #777777; font-size: 24px; font-weight: 800; font-family: 'Nanum Gothic', sans-serif;">
                        환자 케이스<span id="caseNumber">03</span>
                    </div>

                    <!-- Main Content -->
                    <div class="card form-card scrollable-card">
                        <div class="notice-box"
                            style="margin-bottom: 24px; padding: 20px; background-color: #F8F9FA; border-radius: 12px; border: 1px solid #E9ECEF;">
                            <h3 style="font-size: 16px; font-weight: 700; color: #333; margin-bottom: 8px;">설문 준비하기</h3>
                            <ul style="font-size: 14px; color: #666; padding-left: 20px; margin: 0; line-height: 1.6;">
                                <li>한 케이스당 1회 설문이 작성됩니다.</li>
                                <li>추가 케이스는 마이페이지 > 설문 보기에서 등록 하실 수 있습니다.</li>
                            </ul>
                        </div>

                        <h2 class="form-title"
                            style="margin-bottom: 24px; font-size: 20px; font-weight: 700; color: #3196FB;">환자별 설문</h2>

                        <form id="patientCaseForm" onsubmit="handlePatientCaseSubmit(event)">

                            <!-- Question 1: Visit Date -->
                            <div class="question-section">
                                <h3 class="question-title">1. 환자의 이번 방문 날짜는 며칠인가요?</h3>
                                <div class="date-input-group" style="display: flex; align-items: center; gap: 16px;">
                                    <label style="font-size: 20px; color: #171717;">년도</label>
                                    <input type="text" id="visitYear" placeholder="yyyy" class="form-input small"
                                        style="width: 100px;" maxlength="4" required>

                                    <label style="font-size: 20px; color: #171717;">달</label>
                                    <input type="text" id="visitMonth" placeholder="mm" class="form-input small"
                                        style="width: 80px;" maxlength="2" required>

                                    <label style="font-size: 20px; color: #171717;">날짜</label>
                                    <input type="text" id="visitDay" placeholder="dd" class="form-input small"
                                        style="width: 80px;" maxlength="2" required>
                                </div>
                            </div>

                            <!-- Question 2: Visit Type -->
                            <div class="question-section">
                                <h3 class="question-title">2. 가장 최근 진료는 어떻게 이루어졌습니까?</h3>
                                <div class="radio-group">
                                    <div class="radio-item">
                                        <input type="radio" name="visitType" id="visitType1" value="대면">
                                        <label for="visitType1">대면</label>
                                    </div>
                                    <div class="radio-item">
                                        <input type="radio" name="visitType" id="visitType2" value="전화" checked>
                                        <label for="visitType2">전화</label>
                                    </div>
                                    <div class="radio-item">
                                        <input type="radio" name="visitType" id="visitType3" value="원격 플랫폼">
                                        <label for="visitType3">원격 플랫폼</label>
                                    </div>
                                    <div class="radio-item">
                                        <input type="radio" name="visitType" id="visitType4" value="온라인">
                                        <label for="visitType4">온라인</label>
                                    </div>
                                </div>
                            </div>

                            <!-- Question 3: Visit Purpose -->
                            <div class="question-section">
                                <h3 class="question-title">3. 이 환자의 가장 최근 방문 목적을 알려주세요</h3>
                                <div class="radio-group">
                                    <div class="radio-item">
                                        <input type="radio" name="visitPurpose" id="visitPurpose1" value="신환 진료"
                                            checked>
                                        <label for="visitPurpose1">신환 진료</label>
                                    </div>
                                    <div class="radio-item">
                                        <input type="radio" name="visitPurpose" id="visitPurpose2" value="구환 진료 (정기적)">
                                        <label for="visitPurpose2">구환 진료 (정기적)</label>
                                    </div>
                                    <div class="radio-item">
                                        <input type="radio" name="visitPurpose" id="visitPurpose3" value="구환 진료 (비정기적)">
                                        <label for="visitPurpose3">구환 진료 (비정기적)</label>
                                    </div>
                                </div>
                            </div>

                            <!-- Question 4: Main Symptoms -->
                            <div class="question-section">
                                <h3 class="question-title">4. 최근 방문 시 환자의 주요 증상은 무엇이었나요?</h3>
                                <div class="form-group">
                                    <input type="text" id="mainSymptoms" placeholder="주요 증상을 간단히 적어 주세요"
                                        class="form-input" required>
                                </div>
                            </div>

                            <!-- Question 5: Underlying Conditions (Checkbox) -->
                            <div class="question-section">
                                <h3 class="question-title">5. 이 환자의 주요 기저질환이 있다면 선택해 주세요.</h3>
                                <div class="radio-group"> <!-- Checkbox style using radio-group layout -->
                                    <div class="radio-item">
                                        <input type="checkbox" name="conditions" id="condition1" value="고혈압">
                                        <label for="condition1">고혈압</label>
                                    </div>
                                    <div class="radio-item">
                                        <input type="checkbox" name="conditions" id="condition2" value="당뇨">
                                        <label for="condition2">당뇨</label>
                                    </div>
                                    <div class="radio-item">
                                        <input type="checkbox" name="conditions" id="condition3" value="고지혈증">
                                        <label for="condition3">고지혈증</label>
                                    </div>
                                    <div class="radio-item">
                                        <input type="checkbox" name="conditions" id="condition4" value="기타">
                                        <label for="condition4">기타</label>
                                    </div>
                                </div>
                            </div>

                            <!-- Question 6: Medication Changes -->
                            <div class="question-section">
                                <h3 class="question-title">6. 최근 방문 시 처방 약제 변경 여부를 알려주세요.</h3>
                                <div class="radio-group">
                                    <div class="radio-item">
                                        <input type="radio" name="medicationChange" id="medChange1" value="변경 없이 유지"
                                            checked>
                                        <label for="medChange1">변경 없이 유지</label>
                                    </div>
                                    <div class="radio-item">
                                        <input type="radio" name="medicationChange" id="medChange2" value="약제 추가">
                                        <label for="medChange2">약제 추가</label>
                                    </div>
                                    <div class="radio-item">
                                        <input type="radio" name="medicationChange" id="medChange3" value="다른 약제로 교체">
                                        <label for="medChange3">다른 약제로 교체</label>
                                    </div>
                                </div>
                            </div>

                            <!-- Question 7: GI Side Effects -->
                            <div class="question-section">
                                <h3 class="question-title">7. 환자의 위장관 부작용 경험 여부를 알려주세요.</h3>
                                <div class="radio-group">
                                    <div class="radio-item">
                                        <input type="radio" name="sideEffects" id="sideEffect1" value="있음">
                                        <label for="sideEffect1">있음</label>
                                    </div>
                                    <div class="radio-item">
                                        <input type="radio" name="sideEffects" id="sideEffect2" value="없음" checked>
                                        <label for="sideEffect2">없음</label>
                                    </div>
                                </div>
                            </div>

                            <!-- Question 8: PPI Prescription -->
                            <div class="question-section">
                                <h3 class="question-title">8. 해당 환자에게 PPI 계열 약제를 처방하셨나요?</h3>
                                <div class="radio-group">
                                    <div class="radio-item">
                                        <input type="radio" name="ppiPrescription" id="ppi1" value="예">
                                        <label for="ppi1">예</label>
                                    </div>
                                    <div class="radio-item">
                                        <input type="radio" name="ppiPrescription" id="ppi2" value="아니오" checked>
                                        <label for="ppi2">아니오</label>
                                    </div>
                                </div>
                            </div>

                            <!-- Question 9: PPI Reason -->
                            <div class="question-section">
                                <h3 class="question-title">9. PPI 처방(또는 미처방)의 주요 이유를 적어 주세요.</h3>
                                <div class="form-group">
                                    <textarea id="ppiReason" placeholder="간단하게 이유를 적어 주세요" class="form-input"
                                        style="height: 80px; resize: none;" required></textarea>
                                </div>
                            </div>

                            <!-- Question 10: Follow-up Plan -->
                            <div class="question-section">
                                <h3 class="question-title">10. 이 환자의 추적 관찰 계획을 적어 주세요.</h3>
                                <div class="form-group">
                                    <textarea id="followUpPlan" placeholder="예: 3개월 후 외래 방문 예정 등" class="form-input"
                                        style="height: 80px; resize: none;" required></textarea>
                                </div>
                            </div>

                            <!-- Navigation Buttons -->
                            <div class="form-actions">
                                <button type="button" class="btn btn-text" onclick="history.back()">
                                    <svg width="24" height="22" viewBox="0 0 24 22" fill="none">
                                        <path d="M20 11H4M4 11L11 4M4 11L11 18" stroke="#3196FB" stroke-width="3" />
                                    </svg>
                                    이전
                                </button>
                                <button type="submit" class="btn btn-primary">제출</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </section>

        <!-- Submit Success Modal -->
        <div class="modal-overlay" id="submitModal">
            <div class="modal">
                <h2 class="modal-title" style="text-align: center;">설문이 제출되었습니다</h2>

                <p class="modal-description" style="text-align: center; margin-bottom: 24px;">
                    작성해주신 환자 케이스 설문이 저장되었습니다.<br>
                    케이스 목록 페이지로 이동합니다.
                </p>

                <button class="btn btn-primary" onclick="handleModalConfirm()"
                    style="margin: 0 auto; display: block;">확인</button>
            </div>
        </div>

    </div>

    <script>
        // Load Case Number on Page Load
        window.onload = function () {
            // Get existing cases
            const patientCases = JSON.parse(sessionStorage.getItem('patientCases') || '[]');
            const nextCaseNum = patientCases.length + 1;

            // Format number with leading zero (e.g., 01, 02)
            const formattedNum = nextCaseNum < 10 ? '0' + nextCaseNum : nextCaseNum;

            // Update display
            document.getElementById('caseNumber').textContent = formattedNum;
        };

        // Handle Patient Case Form Submit
        function handlePatientCaseSubmit(e) {
            e.preventDefault();

            // validation handled by 'required' attribute mostly

            // Collect Data
            const visitYear = document.getElementById('visitYear').value;
            const visitMonth = document.getElementById('visitMonth').value;
            const visitDay = document.getElementById('visitDay').value;
            const visitDate = `${visitYear}-${visitMonth.padStart(2, '0')}-${visitDay.padStart(2, '0')}`;

            const formData = {
                id: Date.now(), // Generate unique ID
                visitDate: visitDate,
                visitType: document.querySelector('input[name="visitType"]:checked')?.value,
                visitPurpose: document.querySelector('input[name="visitPurpose"]:checked')?.value,
                mainSymptoms: document.getElementById('mainSymptoms').value,
                conditions: Array.from(document.querySelectorAll('input[name="conditions"]:checked')).map(cb => cb.value),
                medicationChange: document.querySelector('input[name="medicationChange"]:checked')?.value,
                sideEffects: document.querySelector('input[name="sideEffects"]:checked')?.value,
                ppiPrescription: document.querySelector('input[name="ppiPrescription"]:checked')?.value,
                ppiReason: document.getElementById('ppiReason').value,
                followUpPlan: document.getElementById('followUpPlan').value,
                timestamp: new Date().toISOString()
            };

            console.log('Form Data:', formData);

            // Save to sessionStorage (Append to list)
            const patientCases = JSON.parse(sessionStorage.getItem('patientCases') || '[]');
            patientCases.push(formData);
            sessionStorage.setItem('patientCases', JSON.stringify(patientCases));

            // Show Modal instead of alert
            document.getElementById('submitModal').classList.add('active');
        }

        // Handle Modal Confirm
        function handleModalConfirm() {
            location.href = 'patient-cases_end.html';
        }

        // ========== Header Icon Modal Functions ==========
        function showMypageModal() {
            document.getElementById('mypageModal').classList.add('active');
        }
        function closeMypageModal() {
            document.getElementById('mypageModal').classList.remove('active');
        }
        function goToMypage() {
            location.href = 'mypage.html';
        }
        function showExitModal() {
            document.getElementById('exitModal').classList.add('active');
        }
        function closeExitModal() {
            document.getElementById('exitModal').classList.remove('active');
        }
        function exitPage() {
            window.open('', '_self', '');
            window.close();
            setTimeout(() => { location.href = 'index.html'; }, 100);
        }
    </script>
</body>

</html>